<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What is it really like to travel by train in Europe?</title>
    <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'League Spartan', sans-serif;
            background-color: white;
            color: #237644;
            line-height: 1.6;
        }

        .header {
            background: url('header/heading_2.png') no-repeat center center;
            padding: 2rem 1rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            color: white;
            opacity: 0.9;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .nav-tabs {
            display: flex;
            background-color: #237644;
            border-bottom: 3px solid #bbebd3;
            justify-content: center;
        }

        .nav-tab {
            background: none;
            border: none;
            color: white;
            padding: 1rem 2rem;
            font-family: 'League Spartan', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tab:hover {
            background-color: rgba(187, 235, 211, 0.2);
        }

        .nav-tab.active {
            background-color: #bbebd3;
            color: #237644;
            border-bottom-color: #237644;
        }

        .tab-content {
            display: none;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 4px 6px rgba(35, 118, 68, 0.1);
            border: 2px solid #bbebd3;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #237644;
            margin-bottom: 1rem;
            text-align: center;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #bbebd3 0%, #e8f5e8 100%);
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #237644;
            box-shadow: 0 2px 4px rgba(35, 118, 68, 0.1);
        }

        .stat-card h3 {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #237644;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #237644;
        }

        .superstar-card {
            background: linear-gradient(135deg, #237644 0%, #1a5a33 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
            box-shadow: 0 4px 8px rgba(35, 118, 68, 0.3);
        }

        .superstar-card h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: #bbebd3;
        }

        .superstar-score {
            font-size: 2rem;
            font-weight: 700;
            color: #bbebd3;
            float: right;
        }

        .operator-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .operator-details span {
            background: rgba(187, 235, 211, 0.2);
            padding: 0.3rem 0.6rem;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        .policy-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .policy-card {
            background: white;
            border: 2px solid #bbebd3;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(35, 118, 68, 0.1);
        }

        .policy-card.excellent {
            border-color: #237644;
            background: linear-gradient(135deg, #e8f5e8 0%, #bbebd3 100%);
        }

        .route-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 2rem 0;
        }

        .route-card {
            background: white;
            border: 2px solid #bbebd3;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
        }

        .route-card.intercity {
            background: linear-gradient(135deg, #bbebd3 0%, #e8f5e8 100%);
        }

        .route-card.international {
            background: linear-gradient(135deg, #237644 0%, #1a5a33 100%);
            color: white;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #237644;
            font-size: 1.1rem;
        }

        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid #c62828;
        }

        .best-routes-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .best-routes-table th,
        .best-routes-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid #bbebd3;
        }

        .best-routes-table th {
            background-color: #237644;
            color: white;
            font-weight: 600;
        }

        .best-routes-table tr:hover {
            background-color: rgba(187, 235, 211, 0.3);
        }

        .best-routes-table .price-excellent {
            background-color: #e8f5e8;
            font-weight: 600;
            color: #237644;
        }

        @media (max-width: 768px) {
            .route-comparison {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tab {
                font-size: 0.9rem;
                padding: 0.8rem 1rem;
            }

            .stat-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Traveling with train in Europe?</h1>
        <p>Analysis of European train operators,<br>routes, and passenger experience</p>
    </div>

    <div class="nav-tabs">
        <button class="nav-tab active" onclick="showTab('operators-by-country')">Operators by Country</button>
        <button class="nav-tab" onclick="showTab('refund-policies')">Refund & Cancellation</button>
        <button class="nav-tab" onclick="showTab('superstar-operators')">Top 5 Superstar Operators</button>
        <button class="nav-tab" onclick="showTab('route-comparison')">Route Comparison</button>
    </div>

    <div id="operators-by-country" class="tab-content active">
        <div class="chart-container">
            <h2 class="chart-title">Number of Train Operators by Country</h2>
            <div id="operators-by-country-chart"></div>
        </div>
        
        <div class="stat-grid">
            <div class="stat-card">
                <h3>Total Countries</h3>
                <div class="value" id="total-countries">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Operators</h3>
                <div class="value" id="total-operators">-</div>
            </div>
            <div class="stat-card">
                <h3>Average Operators per Country</h3>
                <div class="value" id="avg-operators">-</div>
            </div>
            <div class="stat-card">
                <h3>Country with Most Operators</h3>
                <div class="value" id="top-country">-</div>
            </div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Detailed Operators by Country</h2>
            <div id="country-operators-detail"></div>
        </div>
    </div>

    <div id="refund-policies" class="tab-content">
        <div class="chart-container">
            <h2 class="chart-title">Best Refund & Cancellation Policies</h2>
            <div id="policy-rankings"></div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Policy Comparison Metrics</h2>
            <div id="policy-metrics-chart"></div>
        </div>
    </div>

    <div id="superstar-operators" class="tab-content">
        <div class="chart-container">
            <h2 class="chart-title">Top 5 Superstar Operators</h2>
            <p style="text-align: center; margin-bottom: 2rem; color: #666;">
                Based on: Good price, WiFi, electricity plug, catering, high refund %, cancellation possible, modification possible
            </p>
            <div id="superstar-list"></div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Superstar Scoring Methodology</h2>
            <div id="scoring-methodology"></div>
        </div>
    </div>

    <div id="route-comparison" class="tab-content">
        <div class="route-comparison">
            <div class="route-card intercity">
                <h3>Intercity Routes</h3>
                <div class="value" id="intercity-count">-</div>
                <p>Total Routes</p>
                <div style="margin-top: 1rem;">
                    <strong>Avg Price per km: €<span id="intercity-avg-price">-</span></strong><br>
                    <strong>Avg Speed: <span id="intercity-avg-speed">-</span> km/h</strong>
                </div>
            </div>
            
            <div class="route-card international">
                <h3>International Routes</h3>
                <div class="value" id="international-count">-</div>
                <p>Total Routes</p>
                <div style="margin-top: 1rem;">
                    <strong>Avg Price per km: €<span id="international-avg-price">-</span></strong><br>
                    <strong>Avg Speed: <span id="international-avg-speed">-</span> km/h</strong>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Price per km Comparison by Route Type</h2>
            <div id="price-per-km-chart"></div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Best Value Routes (Lowest Price per km)</h2>
            <table class="best-routes-table" id="best-routes-table">
                <thead>
                    <tr>
                        <th>Route</th>
                        <th>Operator</th>
                        <th>Type</th>
                        <th>Distance (km)</th>
                        <th>Price (€)</th>
                        <th>Price per km (€)</th>
                        <th>Speed (km/h)</th>
                    </tr>
                </thead>
                <tbody id="best-routes-body">
                </tbody>
            </table>
        </div>
    </div>

    <div class="loading" id="loading">Loading data...</div>
    <div class="error" id="error" style="display: none;"></div>

    <script>
        let allData = {
            countries: [],
            operators: [],
            routes: [],
            trainOperators: []
        };

        // Show/hide tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Load and parse CSV data - for demo using mock data
        async function loadData() {
            try {
                const files = [
                    'data/country_passenger_km_train_length.csv',
                    'data/operators.csv',
                    'data/route_breakdown.csv',
                    'data/train_operators_comparison.csv'
                ];

                const responses = await Promise.all(files.map(file => fetch(file)));
                const texts = await Promise.all(responses.map(response => {
                    if (!response.ok) throw new Error(`Failed to load ${response.url}`);
                    return response.text();
                }));

                allData.countries = Papa.parse(texts[0], { header: true, dynamicTyping: true }).data;
                allData.operators = Papa.parse(texts[1], { header: true, dynamicTyping: true }).data;
                allData.routes = Papa.parse(texts[2], { header: true, dynamicTyping: true }).data;
                allData.trainOperators = Papa.parse(texts[3], { header: true, dynamicTyping: true }).data;

                // Clean the data
                allData.countries = allData.countries.filter(d => d.country && d.country.trim());
                allData.operators = allData.operators.filter(d => d.operator && d.operator.trim());
                allData.routes = allData.routes.filter(d => d.operator && d.operator.trim());
                allData.trainOperators = allData.trainOperators.filter(d => d.operator && d.operator.trim());

                console.log('Data loaded:', allData);
                
                await initializeVisualization();
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('error').textContent = `Error loading data: ${error.message}`;
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function initializeVisualization() {
            createOperatorsByCountryChart();
            createRefundPolicyAnalysis();
            createSuperstarOperators();
            createRouteComparison();
        }

        function createOperatorsByCountryChart() {
            // Count operators by country
            const operatorsByCountry = d3.rollup(
                allData.operators,
                v => v.length,
                d => d.country
            );

            const data = Array.from(operatorsByCountry, ([country, count]) => ({country, count}))
                .sort((a, b) => b.count - a.count);

            // Update stats
            document.getElementById('total-countries').textContent = data.length;
            document.getElementById('total-operators').textContent = allData.operators.length;
            document.getElementById('avg-operators').textContent = (allData.operators.length / data.length).toFixed(1);
            document.getElementById('top-country').textContent = data[0]?.country || '-';

            // Create chart
            const container = d3.select('#operators-by-country-chart');
            const svg = container.append('svg')
                .attr('width', '100%')
                .attr('height', 400);

            const margin = {top: 20, right: 30, bottom: 100, left: 60};
            const width = 800 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            svg.attr('viewBox', `0 0 800 400`);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .rangeRound([0, width])
                .padding(0.1)
                .domain(data.map(d => d.country));

            const y = d3.scaleLinear()
                .rangeRound([height, 0])
                .domain([0, d3.max(data, d => d.count)]);

            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');

            g.append('g')
                .call(d3.axisLeft(y));

            g.selectAll('.bar')
                .data(data)
                .enter().append('rect')
                .attr('class', 'bar')
                .attr('x', d => x(d.country))
                .attr('y', d => y(d.count))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d.count))
                .attr('fill', '#bbebd3')
                .attr('stroke', '#237644')
                .attr('stroke-width', 1);

            // Add value labels on bars
            g.selectAll('.bar-label')
                .data(data)
                .enter().append('text')
                .attr('class', 'bar-label')
                .attr('x', d => x(d.country) + x.bandwidth() / 2)
                .attr('y', d => y(d.count) - 5)
                .attr('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('font-weight', '600')
                .style('fill', '#237644')
                .text(d => d.count);

            // Create detailed operators list
            const detailContainer = d3.select('#country-operators-detail');
            data.forEach(({country, count}) => {
                const countryOperators = allData.operators.filter(d => d.country === country);
                const operatorList = countryOperators.map(d => d.operator).join(', ');
                
                detailContainer.append('div')
                    .attr('class', 'policy-card')
                    .html(`
                        <h3>${country} (${count} operators)</h3>
                        <p>${operatorList}</p>
                    `);
            });
        }

        function createRefundPolicyAnalysis() {
            // Analyze refund and cancellation policies
            const policyScores = allData.trainOperators.map(op => {
                let score = 0;
                
                if (op.cancellation_possible === 'yes') score += 2;
                if (op.refund_cancell === 'yes') score += 3;
                else if (op.refund_cancell === 'partial') score += 1;
                if (op.modify_posible === 'yes') score += 2;
                
                return {
                    operator: op.operator,
                    score: score,
                    cancellation: op.cancellation_possible,
                    refund: op.refund_cancell,
                    modify: op.modify_posible
                };
            }).sort((a, b) => b.score - a.score);

            // Display top policy operators
            const policyContainer = d3.select('#policy-rankings');
            policyScores.slice(0, 10).forEach((op, i) => {
                const cardClass = i < 3 ? 'policy-card excellent' : 'policy-card';
                policyContainer.append('div')
                    .attr('class', cardClass)
                    .html(`
                        <h3>#${i + 1} ${op.operator}</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
                            <span><strong>Cancellation:</strong> ${op.cancellation}</span>
                            <span><strong>Refund:</strong> ${op.refund}</span>
                            <span><strong>Modify:</strong> ${op.modify}</span>
                        </div>
                        <div style="text-align: right; margin-top: 0.5rem;">
                            <strong>Policy Score: ${op.score}/7</strong>
                        </div>
                    `);
            });

            // Create policy metrics chart
            const policyData = [
                { policy: 'Cancellation Possible', count: allData.trainOperators.filter(d => d.cancellation_possible === 'yes').length },
                { policy: 'Full Refund', count: allData.trainOperators.filter(d => d.refund_cancell === 'yes').length },
                { policy: 'Partial Refund', count: allData.trainOperators.filter(d => d.refund_cancell === 'partial').length },
                { policy: 'Modification Possible', count: allData.trainOperators.filter(d => d.modify_posible === 'yes').length }
            ];

            const metricsContainer = d3.select('#policy-metrics-chart');
            const svg = metricsContainer.append('svg')
                .attr('width', '100%')
                .attr('height', 300);

            const margin = {top: 20, right: 30, bottom: 60, left: 60};
            const width = 600 - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            svg.attr('viewBox', `0 0 600 300`);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .rangeRound([0, width])
                .padding(0.1)
                .domain(policyData.map(d => d.policy));

            const y = d3.scaleLinear()
                .rangeRound([height, 0])
                .domain([0, d3.max(policyData, d => d.count)]);

            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');

            g.append('g')
                .call(d3.axisLeft(y));

            g.selectAll('.bar')
                .data(policyData)
                .enter().append('rect')
                .attr('class', 'bar')
                .attr('x', d => x(d.policy))
                .attr('y', d => y(d.count))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d.count))
                .attr('fill', '#237644')
                .attr('stroke', '#bbebd3')
                .attr('stroke-width', 1);

            g.selectAll('.bar-label')
                .data(policyData)
                .enter().append('text')
                .attr('class', 'bar-label')
                .attr('x', d => x(d.policy) + x.bandwidth() / 2)
                .attr('y', d => y(d.count) - 5)
                .attr('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('font-weight', '600')
                .style('fill', '#237644')
                .text(d => d.count);
        }

        function createSuperstarOperators() {
            // Calculate superstar scores based on multiple criteria
            const superstarScores = allData.trainOperators.map(op => {
                let score = 0;
                let details = [];
                
                // Price factor (higher speed = better value)
                if (op.average_speed > 100) {
                    score += 3;
                    details.push('High Speed');
                } else if (op.average_speed > 80) {
                    score += 2;
                    details.push('Good Speed');
                } else if (op.average_speed > 60) {
                    score += 1;
                    details.push('Decent Speed');
                }
                
                // Services
                if (op.Wifi === 'yes') {
                    score += 1;
                    details.push('WiFi');
                }
                if (op.electricity_plug === 'yes') {
                    score += 1;
                    details.push('Power Outlets');
                }
                if (op.catering_offer === 'yes') {
                    score += 1;
                    details.push('Catering');
                }
                
                // Policy flexibility
                if (op.refund_cancell === 'yes') {
                    score += 2;
                    details.push('Full Refund');
                } else if (op.refund_cancell === 'partial') {
                    score += 1;
                    details.push('Partial Refund');
                }
                
                if (op.cancellation_possible === 'yes') {
                    score += 1;
                    details.push('Cancellation');
                }
                
                if (op.modify_posible === 'yes') {
                    score += 1;
                    details.push('Modification');
                }
                
                return {
                    operator: op.operator,
                    score: score,
                    details: details,
                    speed: op.average_speed,
                    maxScore: 10
                };
            }).sort((a, b) => b.score - a.score);

            // Display top 5 superstar operators
            const superstarContainer = d3.select('#superstar-list');
            superstarScores.slice(0, 5).forEach((op, i) => {
                superstarContainer.append('div')
                    .attr('class', 'superstar-card')
                    .html(`
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3>#${i + 1} ${op.operator}</h3>
                                <p>Average Speed: ${op.speed} km/h</p>
                            </div>
                            <div class="superstar-score">${op.score}/${op.maxScore}</div>
                        </div>
                        <div class="operator-details">
                            ${op.details.map(detail => `<span>${detail}</span>`).join('')}
                        </div>
                    `);
            });

            // Create scoring methodology
            const methodologyContainer = d3.select('#scoring-methodology');
            methodologyContainer.html(`
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div class="stat-card">
                        <h3>Speed Scoring</h3>
                        <p>High Speed (>100 km/h): 3 points<br>
                        Good Speed (80-100 km/h): 2 points<br>
                        Decent Speed (60-80 km/h): 1 point</p>
                    </div>
                    <div class="stat-card">
                        <h3>Service Amenities</h3>
                        <p>WiFi: 1 point<br>
                        Power Outlets: 1 point<br>
                        Catering: 1 point</p>
                    </div>
                    <div class="stat-card">
                        <h3>Policy Flexibility</h3>
                        <p>Full Refund: 2 points<br>
                        Partial Refund: 1 point<br>
                        Cancellation: 1 point<br>
                        Modification: 1 point</p>
                    </div>
                </div>
            `);
        }

        function createRouteComparison() {
            // Separate intercity and international routes
            const intercityRoutes = allData.routes.filter(d => 
                d.intercity_or_international && d.intercity_or_international.toLowerCase().includes('intercity')
            );
            const internationalRoutes = allData.routes.filter(d => 
                d.intercity_or_international && d.intercity_or_international.toLowerCase().includes('international')
            );

            // Calculate averages
            const intercityAvgPrice = d3.mean(intercityRoutes, d => parseFloat(d[' price_eur ']) / d.distance_km) || 0;
            const internationalAvgPrice = d3.mean(internationalRoutes, d => parseFloat(d[' price_eur ']) / d.distance_km) || 0;
            const intercityAvgSpeed = d3.mean(intercityRoutes, d => d.speed_km_per_hour) || 0;
            const internationalAvgSpeed = d3.mean(internationalRoutes, d => d.speed_km_per_hour) || 0;

            // Update route comparison cards
            document.getElementById('intercity-count').textContent = intercityRoutes.length;
            document.getElementById('international-count').textContent = internationalRoutes.length;
            document.getElementById('intercity-avg-price').textContent = intercityAvgPrice.toFixed(3);
            document.getElementById('international-avg-price').textContent = internationalAvgPrice.toFixed(3);
            document.getElementById('intercity-avg-speed').textContent = intercityAvgSpeed.toFixed(1);
            document.getElementById('international-avg-speed').textContent = internationalAvgSpeed.toFixed(1);

            // Create price per km comparison chart
            const allRoutes = [...intercityRoutes, ...internationalRoutes].map(d => ({
                ...d,
                pricePerKm: parseFloat(d[' price_eur ']) / d.distance_km,
                type: d.intercity_or_international
            }));

            const operatorAvgPrices = d3.rollup(
                allRoutes,
                v => ({
                    avgPrice: d3.mean(v, d => d.pricePerKm),
                    count: v.length,
                    types: [...new Set(v.map(d => d.type))]
                }),
                d => d.operator
            );

            const priceData = Array.from(operatorAvgPrices, ([operator, data]) => ({
                operator,
                avgPrice: data.avgPrice,
                count: data.count,
                types: data.types.join(', ')
            })).sort((a, b) => a.avgPrice - b.avgPrice);

            const priceContainer = d3.select('#price-per-km-chart');
            const svg = priceContainer.append('svg')
                .attr('width', '100%')
                .attr('height', 400);

            const margin = {top: 20, right: 30, bottom: 100, left: 80};
            const width = 900 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            svg.attr('viewBox', `0 0 900 400`);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .rangeRound([0, width])
                .padding(0.1)
                .domain(priceData.map(d => d.operator));

            const y = d3.scaleLinear()
                .rangeRound([height, 0])
                .domain([0, d3.max(priceData, d => d.avgPrice)]);

            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');

            g.append('g')
                .call(d3.axisLeft(y));

            // Create tooltip
            const tooltip = d3.select('body')
                .append('div')
                .attr('class', 'tooltip')
                .style('position', 'absolute')
                .style('background', 'rgba(35, 118, 68, 0.9)')
                .style('color', 'white')
                .style('padding', '0.5rem')
                .style('border-radius', '4px')
                .style('pointer-events', 'none')
                .style('font-size', '0.9rem')
                .style('z-index', '1000')
                .style('opacity', 0);

            g.selectAll('.bar')
                .data(priceData)
                .enter().append('rect')
                .attr('class', 'bar')
                .attr('x', d => x(d.operator))
                .attr('y', d => y(d.avgPrice))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d.avgPrice))
                .attr('fill', (d, i) => i < 3 ? '#237644' : '#bbebd3')
                .attr('stroke', '#237644')
                .attr('stroke-width', 1)
                .on('mouseover', function(event, d) {
                    tooltip.transition().duration(200).style('opacity', .9);
                    tooltip.html(`
                        <strong>${d.operator}</strong><br/>
                        Avg Price per km: €${d.avgPrice.toFixed(3)}<br/>
                        Routes: ${d.count}<br/>
                        Types: ${d.types}
                    `)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.transition().duration(500).style('opacity', 0);
                });

            g.selectAll('.bar-label')
                .data(priceData)
                .enter().append('text')
                .attr('class', 'bar-label')
                .attr('x', d => x(d.operator) + x.bandwidth() / 2)
                .attr('y', d => y(d.avgPrice) - 5)
                .attr('text-anchor', 'middle')
                .style('font-size', '8px')
                .style('font-weight', '600')
                .style('fill', '#237644')
                .text(d => `€${d.avgPrice.toFixed(3)}`);

            // Create best routes table
            const bestRoutes = allRoutes
                .sort((a, b) => a.pricePerKm - b.pricePerKm)
                .slice(0, 10);

            const tableBody = document.getElementById('best-routes-body');
            bestRoutes.forEach((route, i) => {
                const row = tableBody.insertRow();
                const cellClass = i < 3 ? 'price-excellent' : '';
                row.innerHTML = `
                    <td class="${cellClass}">${route.route}</td>
                    <td class="${cellClass}">${route.operator}</td>
                    <td class="${cellClass}">${route.type}</td>
                    <td class="${cellClass}">${route.distance_km}</td>
                    <td class="${cellClass}">€${parseFloat(route[' price_eur ']).toFixed(2)}</td>
                    <td class="${cellClass}">€${route.pricePerKm.toFixed(3)}</td>
                    <td class="${cellClass}">${route.speed_km_per_hour}</td>
                `;
            });
        }

        // Initialize the application
        loadData();
    </script>
</body>
</html>
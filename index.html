<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>European Railway Data Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f0f7f4;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            background: url('header/heading_2.png') no-repeat center center;
            color: white;
            text-align: left;
            position: relative;
            overflow: hidden;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            padding-left: 3rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: white;
            padding: 0.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .nav-tab {
            background: none;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: #f0f7f4;
            color: #237644;
        }

        .nav-tab.active {
            background: #237644;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .chart-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #237644;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .stat-card h3 {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #237644;
        }

        #europe-map {
            width: 100%;
            height: 500px;
            background: #f0f7f4;
            border-radius: 8px;
        }

        .country {
            fill: #bbebd3;
            stroke: #237644;
            stroke-width: 0.5;
            transition: fill 0.3s ease;
        }

        .country:hover {
            fill: #237644;
        }

        .tooltip {
            position: absolute;
            padding: 0.75rem;
            background: rgba(35, 118, 68, 0.95);
            color: white;
            border-radius: 8px;
            font-size: 0.9rem;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .selected-country-info {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
            display: none;
        }

        .selected-country-info h3 {
            font-size: 1.5rem;
            color: #237644;
            margin-bottom: 1rem;
        }

        .country-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .country-stat {
            text-align: center;
        }

        .country-stat h4 {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .country-stat .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #237644;
        }

        .country-stat small {
            font-size: 0.8rem;
            color: #999;
        }

        .policy-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .policy-card:hover {
            border-color: #237644;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .policy-card.excellent {
            border-color: #237644;
            background: linear-gradient(135deg, #f0f7f4 0%, #e6f4ea 100%);
        }

        .policy-card h3 {
            color: #237644;
            margin-bottom: 0.5rem;
        }

        .superstar-card {
            background: linear-gradient(135deg, #237644 0%, #2d9f5d 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
        }

        .superstar-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .superstar-card h3 {
            margin-bottom: 0.5rem;
        }

        .superstar-score {
            font-size: 2rem;
            font-weight: 700;
            background: white;
            color: #237644;
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }

        .operator-details {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .operator-details span {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .route-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .route-card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .route-card.intercity::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #237644;
        }

        .route-card.international::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #2d9f5d;
        }

        .route-card h3 {
            color: #237644;
            margin-bottom: 1rem;
        }

        .route-card .value {
            font-size: 3rem;
            font-weight: 700;
            color: #237644;
            margin-bottom: 0.5rem;
        }

        .best-routes-table {
            width: 100%;
            border-collapse: collapse;
        }

        .best-routes-table th,
        .best-routes-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .best-routes-table th {
            background: #f0f7f4;
            color: #237644;
            font-weight: 600;
        }

        .best-routes-table tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: #666;
        }

        .error {
            background: #fee;
            color: #c00;
            padding: 1rem;
            border-radius: 8px;
            margin: 2rem 0;
            text-align: center;
        }

        .chart-bar {
            fill: #bbebd3;
            stroke: #237644;
            stroke-width: 1;
            transition: fill 0.3s ease;
        }

        .chart-bar:hover {
            fill: #237644;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .stat-grid {
                grid-template-columns: 1fr;
            }

            .route-comparison {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
</head>
<body>
    <div class="header">
        <h1>What is it really like to travel<br>by train in Europe?</h1>
        <p>Comprehensive analysis of European train operators,<br>routes, and passenger experience</p>
    </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('europe-map-tab', event)">Europe Map</button>
            <button class="nav-tab" onclick="showTab('operators-by-country', event)">Operators by Country</button>
            <button class="nav-tab" onclick="showTab('refund-policies', event)">Refund & Cancellation</button>
            <button class="nav-tab" onclick="showTab('superstar-operators', event)">Top 5 Superstar Operators</button>
            <button class="nav-tab" onclick="showTab('route-comparison', event)">Route Comparison</button>
        </div>

        <div id="europe-map-tab" class="tab-content active">
            <div class="chart-container">
                <h2 class="chart-title">European Railway Network Overview</h2>
                <p style="text-align: center; margin-bottom: 1rem; color: #666;">
                    Click on any country to see detailed railway statistics. Map shows available countries from dataset.
                </p>
                <div id="europe-map"></div>
            </div>

            <div class="stat-grid">
                <div class="stat-card">
                    <h3>Total Countries</h3>
                    <div class="value" id="map-total-countries">-</div>
                </div>
                <div class="stat-card">
                    <h3>Total Railway Length</h3>
                    <div class="value" id="map-total-length">-</div>
                </div>
                <div class="stat-card">
                    <h3>Average Electrification</h3>
                    <div class="value" id="map-avg-electrification">-</div>
                </div>
                <div class="stat-card">
                    <h3>Most Electrified</h3>
                    <div class="value" id="map-most-electrified">-</div>
                </div>
            </div>

            <div class="selected-country-info" id="selected-country-info">
                <h3 id="selected-country-name">Select a country</h3>
                <div class="country-stats">
                    <div class="country-stat">
                        <h4>Total Railway Length</h4>
                        <div class="value" id="selected-total-length">-</div>
                        <small>kilometers</small>
                    </div>
                    <div class="country-stat">
                        <h4>Electrified Length</h4>
                        <div class="value" id="selected-electrified-length">-</div>
                        <small>kilometers</small>
                    </div>
                    <div class="country-stat">
                        <h4>% Electrified</h4>
                        <div class="value" id="selected-electrified-percent">-</div>
                        <small>of total network</small>
                    </div>
                    <div class="country-stat">
                        <h4>Annual Passengers</h4>
                        <div class="value" id="selected-passengers">-</div>
                        <small>million passenger-km</small>
                    </div>
                </div>
            </div>
        </div>

        <div id="operators-by-country" class="tab-content">
            <div class="chart-container">
                <h2 class="chart-title">Operators by Country</h2>
                <div id="operators-by-country-chart"></div>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">Punctuality vs Delay Across Operators</h2>
                <div id="punctuality-delay-chart"></div>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">Average Speed by Operator</h2>
                <div id="average-speed-chart"></div>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">Service Amenities Matrix</h2>
                <div id="service-amenities-chart"></div>
            </div>
            
            <div class="stat-grid">
                <div class="stat-card">
                    <h3>Total Countries</h3>
                    <div class="value" id="total-countries">-</div>
                </div>
                <div class="stat-card">
                    <h3>Total Operators</h3>
                    <div class="value" id="total-operators">-</div>
                </div>
                <div class="stat-card">
                    <h3>Average Operators per Country</h3>
                    <div class="value" id="avg-operators">-</div>
                </div>
                <div class="stat-card">
                    <h3>Country with Most Operators</h3>
                    <div class="value" id="top-country">-</div>
                </div>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">Detailed Operators by Country</h2>
                <div id="country-operators-detail"></div>
            </div>
        </div>

        <div id="refund-policies" class="tab-content">
            <div class="chart-container">
                <h2 class="chart-title">Best Refund & Cancellation Policies</h2>
                <div id="policy-rankings"></div>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">Policy Comparison Metrics</h2>
                <div id="policy-metrics-chart"></div>
            </div>
        </div>

        <div id="superstar-operators" class="tab-content">
            <div class="chart-container">
                <h2 class="chart-title">Top 5 Superstar Operators</h2>
                <p style="text-align: center; margin-bottom: 2rem; color: #666;">
                    Based on: Speed, WiFi, electricity plug, catering, refund policies, and flexibility
                </p>
                <div id="superstar-list"></div>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">Superstar Scoring Methodology</h2>
                <div id="scoring-methodology"></div>
            </div>
        </div>

        <div id="route-comparison" class="tab-content">
            <div class="route-comparison">
                <div class="route-card intercity">
                    <h3>Intercity Routes</h3>
                    <div class="value" id="intercity-count">-</div>
                    <p>Total Routes</p>
                    <div style="margin-top: 1rem;">
                        <strong>Avg Price per km: €<span id="intercity-avg-price">-</span></strong><br>
                        <strong>Avg Speed: <span id="intercity-avg-speed">-</span> km/h</strong>
                    </div>
                </div>
                
                <div class="route-card international">
                    <h3>International Routes</h3>
                    <div class="value" id="international-count">-</div>
                    <p>Total Routes</p>
                    <div style="margin-top: 1rem;">
                        <strong>Avg Price per km: €<span id="international-avg-price">-</span></strong><br>
                        <strong>Avg Speed: <span id="international-avg-speed">-</span> km/h</strong>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">Price per km Comparison by Route Type</h2>
                <div id="price-per-km-chart"></div>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">Best Value Routes (Lowest Price per km)</h2>
                <table class="best-routes-table" id="best-routes-table">
                    <thead>
                        <tr>
                            <th>Route</th>
                            <th>Operator</th>
                            <th>Type</th>
                            <th>Distance (km)</th>
                            <th>Price (€)</th>
                            <th>Price per km (€)</th>
                            <th>Speed (km/h)</th>
                        </tr>
                    </thead>
                    <tbody id="best-routes-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">Loading data...</div>
    <div class="error" id="error" style="display: none;"></div>

    <script>
        let allData = {
            countries: [],
            operators: [],
            routes: [],
            trainOperators: []
        };

        // Utility function to safely parse numbers
        function safeParseFloat(value) {
            if (value === null || value === undefined || value === '') return 0;
            const parsed = parseFloat(String(value).replace(/[^\d.-]/g, ''));
            return isNaN(parsed) ? 0 : parsed;
        }

        function safeParseInt(value) {
            if (value === null || value === undefined || value === '') return 0;
            const parsed = parseInt(String(value).replace(/[^\d-]/g, ''));
            return isNaN(parsed) ? 0 : parsed;
        }

        // Load CSV data using Papa Parse
        async function loadData() {
            try {
                const files = [
                    'country_passenger_km_train_length.csv',
                    'operators.csv',
                    'route_breakdown.csv',
                    'operators_comparison.csv'
                ];

                const responses = await Promise.all(files.map(file => 
                    fetch(file).catch(err => {
                        console.warn(`Failed to load ${file}:`, err);
                        return { ok: false, text: () => '' };
                    })
                ));

                const texts = await Promise.all(responses.map(response => 
                    response.ok ? response.text() : ''
                ));

                // Parse CSV data with error handling
                allData.countries = texts[0] ? Papa.parse(texts[0], { header: true, dynamicTyping: true }).data : [];
                allData.operators = texts[1] ? Papa.parse(texts[1], { header: true, dynamicTyping: true }).data : [];
                allData.routes = texts[2] ? Papa.parse(texts[2], { header: true, dynamicTyping: true }).data : [];
                allData.trainOperators = texts[3] ? Papa.parse(texts[3], { header: true, dynamicTyping: true }).data : [];

                // Clean the data and fix column names
                allData.countries = allData.countries.filter(d => d.country && d.country.trim()).map(d => ({
                    country: d.country.trim(),
                    electrified_rail_length: safeParseFloat(d.eletrified_rail_length || d.electrified_rail_length),
                    total_length: safeParseFloat(d.total_length),
                    percentage_electrified: safeParseFloat(d.pecentage_electried_length || d.percentage_electrified_length),
                    passenger_km: safeParseFloat(d.passenger_km)
                }));

                allData.operators = allData.operators.filter(d => d.operator && d.operator.trim());
                allData.routes = allData.routes.filter(d => d.operator && d.operator.trim()).map(d => ({
                    ...d,
                    price_eur: safeParseFloat(d[' price_eur '] || d.price_eur),
                    price_per_km: safeParseFloat(d[' price_per_km '] || d.price_per_km),
                    distance_km: safeParseFloat(d.distance_km),
                    speed_km_per_hour: safeParseFloat(d.speed_km_per_hour),
                    duration_min: safeParseInt(d.duration_min)
                }));

                allData.trainOperators = allData.trainOperators.filter(d => d.operator && d.operator.trim()).map(d => ({
                    ...d,
                    average_speed: safeParseFloat(d.average_speed),
                    delay_above_min: safeParseFloat(d.delay_above_min),
                    can_book_before_month: safeParseInt(d.can_book_before_month)
                }));

                console.log('Data loaded:', allData);
                
                await initializeVisualization();
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('error').textContent = `Error loading data: ${error.message}`;
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Show/hide tabs
        function showTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            if (event && event.target) {
                event.target.classList.add('active');
            }

            // Initialize specific visualizations when tabs are shown
            if (tabName === 'operators-by-country' && allData.operators.length > 0) {
                createOperatorsByCountryChart();
                createPunctualityChart();
                createSpeedChart();
                createAmenitiesChart();
            }
        }

        async function initializeVisualization() {
            createMapVisualization();
            createMapStatistics();
            if (allData.operators.length > 0) {
                createOperatorsByCountryChart();
                createRefundPolicyAnalysis();
                createSuperstarOperators();
                createRouteComparison();
            }
        }

        // Europe Map Functions
        function createMapVisualization() {
            const mapContainer = document.getElementById('europe-map');
            mapContainer.innerHTML = '';
            
            if (allData.countries.length === 0) {
                mapContainer.innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; height: 500px; background: #f8f9fa; border-radius: 8px;">
                        <div style="text-align: center; color: #666;">
                            <h3>Country Data Visualization</h3>
                            <p>Click on a country name below to see details</p>
                        </div>
                    </div>
                `;
                
                // Create a simple country list as fallback
                const countryList = document.createElement('div');
                countryList.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;';
                
                allData.countries.forEach(country => {
                    const countryCard = document.createElement('div');
                    countryCard.style.cssText = 'background: white; padding: 1rem; border-radius: 8px; cursor: pointer; border: 2px solid #e0e0e0; transition: border-color 0.3s;';
                    countryCard.innerHTML = `
                        <h4 style="color: #237644; margin-bottom: 0.5rem;">${country.country}</h4>
                        <p style="font-size: 0.9rem; color: #666;">Length: ${country.total_length.toLocaleString()} km</p>
                        <p style="font-size: 0.9rem; color: #666;">Electrified: ${country.percentage_electrified.toFixed(1)}%</p>
                    `;
                    countryCard.addEventListener('click', () => selectCountry(country));
                    countryCard.addEventListener('mouseenter', () => countryCard.style.borderColor = '#237644');
                    countryCard.addEventListener('mouseleave', () => countryCard.style.borderColor = '#e0e0e0');
                    countryList.appendChild(countryCard);
                });
                
                mapContainer.appendChild(countryList);
                return;
            }
        }

        function selectCountry(countryInfo) {
            const infoDiv = document.getElementById('selected-country-info');
            infoDiv.style.display = 'block';
            
            document.getElementById('selected-country-name').textContent = countryInfo.country;
            document.getElementById('selected-total-length').textContent = countryInfo.total_length.toLocaleString();
            document.getElementById('selected-electrified-length').textContent = countryInfo.electrified_rail_length.toLocaleString();
            document.getElementById('selected-electrified-percent').textContent = countryInfo.percentage_electrified.toFixed(1) + '%';
            document.getElementById('selected-passengers').textContent = countryInfo.passenger_km.toLocaleString();
        }

        function createMapStatistics() {
            if (!allData.countries || allData.countries.length === 0) {
                return;
            }

            const totalCountries = allData.countries.length;
            const totalLength = allData.countries.reduce((sum, d) => sum + d.total_length, 0);
            const avgElectrification = allData.countries.reduce((sum, d) => sum + d.percentage_electrified, 0) / totalCountries;
            const mostElectrified = allData.countries.reduce((max, d) => d.percentage_electrified > max.percentage_electrified ? d : max, allData.countries[0]);

            document.getElementById('map-total-countries').textContent = totalCountries;
            document.getElementById('map-total-length').textContent = Math.round(totalLength).toLocaleString() + ' km';
            document.getElementById('map-avg-electrification').textContent = Math.round(avgElectrification) + '%';
            document.getElementById('map-most-electrified').textContent = mostElectrified.country;
        }

        function createOperatorsByCountryChart() {
            if (!allData.operators || allData.operators.length === 0) return;

            // Count operators by country
            const operatorsByCountry = d3.rollup(
                allData.operators,
                v => v.length,
                d => d.country
            );

            const data = Array.from(operatorsByCountry, ([country, count]) => ({country, count}))
                .sort((a, b) => b.count - a.count);

            // Update stats
            document.getElementById('total-countries').textContent = data.length;
            document.getElementById('total-operators').textContent = allData.operators.length;
            document.getElementById('avg-operators').textContent = (allData.operators.length / data.length).toFixed(1);
            document.getElementById('top-country').textContent = data[0]?.country || '-';

            // Create chart
            const container = d3.select('#operators-by-country-chart');
            container.selectAll('*').remove();
            
            const svg = container.append('svg')
                .attr('width', '100%')
                .attr('height', 400);

            const margin = {top: 20, right: 30, bottom: 100, left: 60};
            const width = 800 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            svg.attr('viewBox', `0 0 800 400`);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .rangeRound([0, width])
                .padding(0.1)
                .domain(data.map(d => d.country));

            const y = d3.scaleLinear()
                .rangeRound([height, 0])
                .domain([0, d3.max(data, d => d.count)]);

            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');

            g.append('g')
                .call(d3.axisleft(y));

            g.selectAll('.bar')
                .data(data)
                .enter().append('rect')
                .attr('class', 'chart-bar')
                .attr('x', d => x(d.country))
                .attr('y', d => y(d.count))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d.count));

            // Add value labels on bars
            g.selectAll('.bar-label')
                .data(data)
                .enter().append('text')
                .attr('class', 'bar-label')
                .attr('x', d => x(d.country) + x.bandwidth() / 2)
                .attr('y', d => y(d.count) - 5)
                .attr('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('font-weight', '600')
                .style('fill', '#237644')
                .text(d => d.count);

            // Create detailed operators list
            const detailContainer = d3.select('#country-operators-detail');
            detailContainer.selectAll('*').remove();
            
            data.forEach(({country, count}) => {
                const countryOperators = allData.operators.filter(d => d.country === country);
                const operatorList = countryOperators.map(d => d.operator).join(', ');
                
                detailContainer.append('div')
                    .attr('class', 'policy-card')
                    .html(`
                        <h3>${country} (${count} operators)</h3>
                        <p>${operatorList}</p>
                    `);
            });
        }

        function createPunctualityChart() {
            if (!allData.trainOperators || allData.trainOperators.length === 0) return;

            const punctualityData = allData.trainOperators
                .filter(d => d.on_time_percentage && d.delay_above_min !== undefined)
                .map(d => ({
                    operator: d.operator,
                    onTime: safeParseFloat(d.on_time_percentage.replace('%', '')),
                    avgDelay: d.delay_above_min
                }))
                .sort((a, b) => b.onTime - a.onTime)
                .slice(0, 15);

            const container = d3.select('#punctuality-delay-chart');
            container.selectAll('*').remove();
            
            const svg = container.append('svg')
                .attr('width', '100%')
                .attr('height', 400);

            const margin = {top: 20, right: 30, bottom: 120, left: 60};
            const width = 800 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            svg.attr('viewBox', `0 0 800 400`);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .rangeRound([0, width])
                .padding(0.1)
                .domain(punctualityData.map(d => d.operator));

            const y = d3.scaleLinear()
                .rangeRound([height, 0])
                .domain([0, 100]);

            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');

            g.append('g')
                .call(d3.axisLeft(y))
                .append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 6)
                .attr('dy', '0.71em')
                .attr('text-anchor', 'end')
                .text('On-time Percentage (%)');

            g.selectAll('.bar')
                .data(punctualityData)
                .enter().append('rect')
                .attr('class', 'chart-bar')
                .attr('x', d => x(d.operator))
                .attr('y', d => y(d.onTime))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d.onTime));

            g.selectAll('.bar-label')
                .data(punctualityData)
                .enter().append('text')
                .attr('x', d => x(d.operator) + x.bandwidth() / 2)
                .attr('y', d => y(d.onTime) - 5)
                .attr('text-anchor', 'middle')
                .style('font-size', '10px')
                .style('fill', '#237644')
                .text(d => d.onTime.toFixed(1) + '%');
        }

        function createSpeedChart() {
            if (!allData.trainOperators || allData.trainOperators.length === 0) return;

            const speedData = allData.trainOperators
                .filter(d => d.average_speed > 0)
                .sort((a, b) => b.average_speed - a.average_speed)
                .slice(0, 15);

            const container = d3.select('#average-speed-chart');
            container.selectAll('*').remove();
            
            const svg = container.append('svg')
                .attr('width', '100%')
                .attr('height', 400);

            const margin = {top: 20, right: 30, bottom: 120, left: 60};
            const width = 800 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            svg.attr('viewBox', `0 0 800 400`);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .rangeRound([0, width])
                .padding(0.1)
                .domain(speedData.map(d => d.operator));

            const y = d3.scaleLinear()
                .rangeRound([height, 0])
                .domain([0, d3.max(speedData, d => d.average_speed)]);

            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');

            g.append('g')
                .call(d3.axisLeft(y))
                .append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 6)
                .attr('dy', '0.71em')
                .attr('text-anchor', 'end')
                .text('Average Speed (km/h)');

            g.selectAll('.bar')
                .data(speedData)
                .enter().append('rect')
                .attr('class', 'chart-bar')
                .attr('x', d => x(d.operator))
                .attr('y', d => y(d.average_speed))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d.average_speed));

            g.selectAll('.bar-label')
                .data(speedData)
                .enter().append('text')
                .attr('x', d => x(d.operator) + x.bandwidth() / 2)
                .attr('y', d => y(d.average_speed) - 5)
                .attr('text-anchor', 'middle')
                .style('font-size', '10px')
                .style('fill', '#237644')
                .text(d => d.average_speed.toFixed(0));
        }

        function createAmenitiesChart() {
            if (!allData.trainOperators || allData.trainOperators.length === 0) return;

            const amenityData = [
                { amenity: 'WiFi', count: allData.trainOperators.filter(d => d.Wifi === 'yes').length },
                { amenity: 'Power Outlets', count: allData.trainOperators.filter(d => d.electricity_plug === 'yes').length },
                { amenity: 'Catering', count: allData.trainOperators.filter(d => d.catering_offer === 'yes').length },
                { amenity: 'Night Trains', count: allData.trainOperators.filter(d => d.night_train === 'yes').length },
                { amenity: 'Bike Transport', count: allData.trainOperators.filter(d => d.passenger_with_bike === 'yes').length }
            ];

            const container = d3.select('#service-amenities-chart');
            container.selectAll('*').remove();
            
            const svg = container.append('svg')
                .attr('width', '100%')
                .attr('height', 300);

            const margin = {top: 20, right: 30, bottom: 60, left: 60};
            const width = 600 - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            svg.attr('viewBox', `0 0 600 300`);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .rangeRound([0, width])
                .padding(0.1)
                .domain(amenityData.map(d => d.amenity));

            const y = d3.scaleLinear()
                .rangeRound([height, 0])
                .domain([0, d3.max(amenityData, d => d.count)]);

            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');

            g.append('g')
                .call(d3.axisLeft(y));

            g.selectAll('.bar')
                .data(amenityData)
                .enter().append('rect')
                .attr('class', 'chart-bar')
                .attr('x', d => x(d.amenity))
                .attr('y', d => y(d.count))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d.count));

            g.selectAll('.bar-label')
                .data(amenityData)
                .enter().append('text')
                .attr('x', d => x(d.amenity) + x.bandwidth() / 2)
                .attr('y', d => y(d.count) - 5)
                .attr('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('fill', '#237644')
                .text(d => d.count);
        }

        function createRefundPolicyAnalysis() {
            if (!allData.trainOperators || allData.trainOperators.length === 0) return;

            // Analyze refund and cancellation policies
            const policyScores = allData.trainOperators.map(op => {
                let score = 0;
                
                if (op.cancellation_possible === 'yes') score += 2;
                if (op.refund_cancell === 'yes') score += 3;
                else if (op.refund_cancell === 'partial') score += 1;
                if (op.modify_posible === 'yes') score += 2;
                
                return {
                    operator: op.operator,
                    score: score,
                    cancellation: op.cancellation_possible || 'no',
                    refund: op.refund_cancell || 'no',
                    modify: op.modify_posible || 'no'
                };
            }).sort((a, b) => b.score - a.score);

            // Display top policy operators
            const policyContainer = d3.select('#policy-rankings');
            policyContainer.selectAll('*').remove();
            
            policyScores.slice(0, 10).forEach((op, i) => {
                const cardClass = i < 3 ? 'policy-card excellent' : 'policy-card';
                policyContainer.append('div')
                    .attr('class', cardClass)
                    .html(`
                        <h3>#${i + 1} ${op.operator}</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
                            <span><strong>Cancellation:</strong> ${op.cancellation}</span>
                            <span><strong>Refund:</strong> ${op.refund}</span>
                            <span><strong>Modify:</strong> ${op.modify}</span>
                        </div>
                        <div style="text-align: right; margin-top: 0.5rem;">
                            <strong>Policy Score: ${op.score}/7</strong>
                        </div>
                    `);
            });

            // Create policy metrics chart
            const policyData = [
                { policy: 'Cancellation Possible', count: allData.trainOperators.filter(d => d.cancellation_possible === 'yes').length },
                { policy: 'Full Refund', count: allData.trainOperators.filter(d => d.refund_cancell === 'yes').length },
                { policy: 'Partial Refund', count: allData.trainOperators.filter(d => d.refund_cancell === 'partial').length },
                { policy: 'Modification Possible', count: allData.trainOperators.filter(d => d.modify_posible === 'yes').length }
            ];

            const metricsContainer = d3.select('#policy-metrics-chart');
            metricsContainer.selectAll('*').remove();
            
            const svg = metricsContainer.append('svg')
                .attr('width', '100%')
                .attr('height', 300);

            const margin = {top: 20, right: 30, bottom: 60, left: 60};
            const width = 600 - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            svg.attr('viewBox', `0 0 600 300`);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .rangeRound([0, width])
                .padding(0.1)
                .domain(policyData.map(d => d.policy));

            const y = d3.scaleLinear()
                .rangeRound([height, 0])
                .domain([0, d3.max(policyData, d => d.count)]);

            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');

            g.append('g')
                .call(d3.axisLeft(y));

            g.selectAll('.bar')
                .data(policyData)
                .enter().append('rect')
                .attr('class', 'chart-bar')
                .attr('x', d => x(d.policy))
                .attr('y', d => y(d.count))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d.count))
                .style('fill', '#237644');

            g.selectAll('.bar-label')
                .data(policyData)
                .enter().append('text')
                .attr('x', d => x(d.policy) + x.bandwidth() / 2)
                .attr('y', d => y(d.count) - 5)
                .attr('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('fill', '#237644')
                .text(d => d.count);
        }

        function createSuperstarOperators() {
            if (!allData.trainOperators || allData.trainOperators.length === 0) return;

            // Calculate superstar scores based on multiple criteria
            const superstarScores = allData.trainOperators.map(op => {
                let score = 0;
                let details = [];
                
                // Speed factor
                if (op.average_speed > 100) {
                    score += 3;
                    details.push('High Speed');
                } else if (op.average_speed > 80) {
                    score += 2;
                    details.push('Good Speed');
                } else if (op.average_speed > 60) {
                    score += 1;
                    details.push('Decent Speed');
                }
                
                // Services
                if (op.Wifi === 'yes') {
                    score += 1;
                    details.push('WiFi');
                }
                if (op.electricity_plug === 'yes') {
                    score += 1;
                    details.push('Power Outlets');
                }
                if (op.catering_offer === 'yes') {
                    score += 1;
                    details.push('Catering');
                }
                
                // Policy flexibility
                if (op.refund_cancell === 'yes') {
                    score += 2;
                    details.push('Full Refund');
                } else if (op.refund_cancell === 'partial') {
                    score += 1;
                    details.push('Partial Refund');
                }
                
                if (op.cancellation_possible === 'yes') {
                    score += 1;
                    details.push('Cancellation');
                }
                
                if (op.modify_posible === 'yes') {
                    score += 1;
                    details.push('Modification');
                }
                
                return {
                    operator: op.operator,
                    score: score,
                    details: details,
                    speed: op.average_speed || 0,
                    maxScore: 10
                };
            }).sort((a, b) => b.score - a.score);

            // Display top 5 superstar operators
            const superstarContainer = d3.select('#superstar-list');
            superstarContainer.selectAll('*').remove();
            
            superstarScores.slice(0, 5).forEach((op, i) => {
                superstarContainer.append('div')
                    .attr('class', 'superstar-card')
                    .html(`
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3>#${i + 1} ${op.operator}</h3>
                                <p>Average Speed: ${op.speed.toFixed(0)} km/h</p>
                            </div>
                            <div class="superstar-score">${op.score}/${op.maxScore}</div>
                        </div>
                        <div class="operator-details">
                            ${op.details.map(detail => `<span>${detail}</span>`).join('')}
                        </div>
                    `);
            });

            // Create scoring methodology
            const methodologyContainer = d3.select('#scoring-methodology');
            methodologyContainer.html(`
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div class="stat-card">
                        <h3>Speed Scoring</h3>
                        <p>High Speed (>100 km/h): 3 points<br>
                        Good Speed (80-100 km/h): 2 points<br>
                        Decent Speed (60-80 km/h): 1 point</p>
                    </div>
                    <div class="stat-card">
                        <h3>Service Amenities</h3>
                        <p>WiFi: 1 point<br>
                        Power Outlets: 1 point<br>
                        Catering: 1 point</p>
                    </div>
                    <div class="stat-card">
                        <h3>Policy Flexibility</h3>
                        <p>Full Refund: 2 points<br>
                        Partial Refund: 1 point<br>
                        Cancellation: 1 point<br>
                        Modification: 1 point</p>
                    </div>
                </div>
            `);
        }

        function createRouteComparison() {
            if (!allData.routes || allData.routes.length === 0) return;

            // Separate intercity and international routes
            const intercityRoutes = allData.routes.filter(d => 
                d.intercity_or_international && d.intercity_or_international.toLowerCase().includes('intercity')
            );
            const internationalRoutes = allData.routes.filter(d => 
                d.intercity_or_international && d.intercity_or_international.toLowerCase().includes('international')
            );

            // Calculate averages with safe parsing
            const intercityAvgPrice = intercityRoutes.length > 0 ? 
                d3.mean(intercityRoutes.filter(d => d.price_eur > 0 && d.distance_km > 0), d => d.price_eur / d.distance_km) || 0 : 0;
            const internationalAvgPrice = internationalRoutes.length > 0 ? 
                d3.mean(internationalRoutes.filter(d => d.price_eur > 0 && d.distance_km > 0), d => d.price_eur / d.distance_km) || 0 : 0;
            const intercityAvgSpeed = intercityRoutes.length > 0 ? 
                d3.mean(intercityRoutes.filter(d => d.speed_km_per_hour > 0), d => d.speed_km_per_hour) || 0 : 0;
            const internationalAvgSpeed = internationalRoutes.length > 0 ? 
                d3.mean(internationalRoutes.filter(d => d.speed_km_per_hour > 0), d => d.speed_km_per_hour) || 0 : 0;

            // Update route comparison cards
            document.getElementById('intercity-count').textContent = intercityRoutes.length;
            document.getElementById('international-count').textContent = internationalRoutes.length;
            document.getElementById('intercity-avg-price').textContent = intercityAvgPrice.toFixed(3);
            document.getElementById('international-avg-price').textContent = internationalAvgPrice.toFixed(3);
            document.getElementById('intercity-avg-speed').textContent = intercityAvgSpeed.toFixed(1);
            document.getElementById('international-avg-speed').textContent = internationalAvgSpeed.toFixed(1);

            // Create price per km chart
            const chartData = [
                { type: 'Intercity', avgPrice: intercityAvgPrice },
                { type: 'International', avgPrice: internationalAvgPrice }
            ].filter(d => d.avgPrice > 0);

            if (chartData.length > 0) {
                const container = d3.select('#price-per-km-chart');
                container.selectAll('*').remove();
                
                const svg = container.append('svg')
                    .attr('width', '100%')
                    .attr('height', 300);

                const margin = {top: 20, right: 30, bottom: 60, left: 60};
                const width = 400 - margin.left - margin.right;
                const height = 300 - margin.top - margin.bottom;

                svg.attr('viewBox', `0 0 400 300`);

                const g = svg.append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);

                const x = d3.scaleBand()
                    .rangeRound([0, width])
                    .padding(0.1)
                    .domain(chartData.map(d => d.type));

                const y = d3.scaleLinear()
                    .rangeRound([height, 0])
                    .domain([0, d3.max(chartData, d => d.avgPrice)]);

                g.append('g')
                    .attr('transform', `translate(0,${height})`)
                    .call(d3.axisBottom(x));

                g.append('g')
                    .call(d3.axisLeft(y))
                    .append('text')
                    .attr('transform', 'rotate(-90)')
                    .attr('y', 6)
                    .attr('dy', '0.71em')
                    .attr('text-anchor', 'end')
                    .text('Price per km (€)');

                g.selectAll('.bar')
                    .data(chartData)
                    .enter().append('rect')
                    .attr('class', 'chart-bar')
                    .attr('x', d => x(d.type))
                    .attr('y', d => y(d.avgPrice))
                    .attr('width', x.bandwidth())
                    .attr('height', d => height - y(d.avgPrice));

                g.selectAll('.bar-label')
                    .data(chartData)
                    .enter().append('text')
                    .attr('x', d => x(d.type) + x.bandwidth() / 2)
                    .attr('y', d => y(d.avgPrice) - 5)
                    .attr('text-anchor', 'middle')
                    .style('font-size', '12px')
                    .style('fill', '#237644')
                    .text(d => '€' + d.avgPrice.toFixed(3));
            }

            // Create best value routes table
            const tableBody = document.getElementById('best-routes-body');
            tableBody.innerHTML = '';
            
            // Sort routes by price per km
            const sortedRoutes = allData.routes
                .filter(route => route.price_eur > 0 && route.distance_km > 0)
                .map(route => ({
                    ...route,
                    pricePerKm: route.price_eur / route.distance_km
                }))
                .sort((a, b) => a.pricePerKm - b.pricePerKm);
            
            sortedRoutes.slice(0, 10).forEach(route => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${route.route || '-'}</td>
                    <td>${route.operator || '-'}</td>
                    <td>${route.intercity_or_international || '-'}</td>
                    <td>${route.distance_km.toFixed(0)}</td>
                    <td>€${route.price_eur.toFixed(2)}</td>
                    <td>€${route.pricePerKm.toFixed(3)}</td>
                    <td>${route.speed_km_per_hour.toFixed(0)}</td>
                `;
            });
        }

        // Initialize the application
        loadData();
    </script>
</body>
</html>
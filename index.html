<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What is it really like to travel by train in Europe?</title>
    <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'League Spartan', sans-serif;
            background-color: white;
            color: #237644;
            line-height: 1.6;
        }

        .header {
            background: url('header/heading_2.png') no-repeat center center;
            background-size: cover;
            padding: 2rem 1rem;
            text-align: left;
            position: relative;
            overflow: hidden;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            padding-left: 3rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #237644;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            color: #237644;
            opacity: 0.9;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .nav-tabs {
            display: flex;
            background-color: #237644;
            border-bottom: 3px solid #bbebd3;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: none;
            border: none;
            color: white;
            padding: 1rem 1.5rem;
            font-family: 'League Spartan', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tab:hover {
            background-color: rgba(187, 235, 211, 0.2);
        }

        .nav-tab.active {
            background-color: #bbebd3;
            color: #237644;
            border-bottom-color: #237644;
        }

        .tab-content {
            display: none;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 4px 6px rgba(35, 118, 68, 0.1);
            border: 2px solid #bbebd3;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #237644;
            margin-bottom: 1rem;
            text-align: center;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #bbebd3 0%, #e8f5e8 100%);
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #237644;
            box-shadow: 0 2px 4px rgba(35, 118, 68, 0.1);
        }

        .stat-card h3 {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #237644;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #237644;
        }

        .superstar-card {
            background: linear-gradient(135deg, #237644 0%, #1a5a33 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
            box-shadow: 0 4px 8px rgba(35, 118, 68, 0.3);
        }

        .superstar-card h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: #bbebd3;
        }

        .superstar-score {
            font-size: 2rem;
            font-weight: 700;
            color: #bbebd3;
            float: right;
        }

        .operator-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .operator-details span {
            background: rgba(187, 235, 211, 0.2);
            padding: 0.3rem 0.6rem;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        .policy-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .policy-card {
            background: white;
            border: 2px solid #bbebd3;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(35, 118, 68, 0.1);
        }

        .policy-card.excellent {
            border-color: #237644;
            background: linear-gradient(135deg, #e8f5e8 0%, #bbebd3 100%);
        }

        .route-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 2rem 0;
        }

        .route-card {
            background: white;
            border: 2px solid #bbebd3;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
        }

        .route-card.intercity {
            background: linear-gradient(135deg, #bbebd3 0%, #e8f5e8 100%);
        }

        .route-card.international {
            background: linear-gradient(135deg, #237644 0%, #1a5a33 100%);
            color: white;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #237644;
            font-size: 1.1rem;
        }

        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid #c62828;
        }

        .best-routes-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .best-routes-table th,
        .best-routes-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid #bbebd3;
        }

        .best-routes-table th {
            background-color: #237644;
            color: white;
            font-weight: 600;
        }

        .best-routes-table tr:hover {
            background-color: rgba(187, 235, 211, 0.3);
        }

        .best-routes-table .price-excellent {
            background-color: #e8f5e8;
            font-weight: 600;
            color: #237644;
        }

        /* Map-specific styles */
        #europe-map {
            width: 100%;
            height: 400px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #bbebd3;
        }

        .country {
            fill: #bbebd3;
            stroke: #237644;
            stroke-width: 0.5;
            cursor: pointer;
            transition: fill 0.3s ease;
        }

        .country:hover {
            fill: #237644;
        }

        .country-label {
            pointer-events: none;
            font-family: 'League Spartan', sans-serif;
        }

        .tooltip {
            position: absolute;
            background: rgba(35, 118, 68, 0.95);
            color: white;
            padding: 0.8rem;
            border-radius: 8px;
            font-size: 0.9rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            pointer-events: none;
            z-index: 1000;
            max-width: 250px;
        }

        .selected-country-info {
            background: linear-gradient(135deg, #237644 0%, #1a5a33 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
            display: none;
        }

        .selected-country-info h3 {
            color: #bbebd3;
            margin-bottom: 1rem;
        }

        .country-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .country-stat {
            background: rgba(187, 235, 211, 0.2);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .route-comparison {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tab {
                font-size: 0.9rem;
                padding: 0.8rem 1rem;
            }

            .stat-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>What is it really like to travel<br>by train in Europe?</h1>
        <p>Comprehensive analysis of European train operators,<br>routes, and passenger experience</p>
    </div>

    <div class="nav-tabs">
        <button class="nav-tab active" onclick="showTab('europe-map-tab')">Europe map</button>
        <button class="nav-tab" onclick="showTab('operators-by-country')">Operators by country</button>
        <button class="nav-tab" onclick="showTab('refund-policies')">Refund & Cancellation</button>
        <button class="nav-tab" onclick="showTab('superstar-operators')">Top 5 Superstar operators</button>
        <button class="nav-tab" onclick="showTab('route-comparison')">Route comparison</button>
    </div>

    <div id="europe-map-tab" class="tab-content active">
    <div class="chart-container">
        <h2 class="chart-title">European Railway Network Overview</h2>
        <p style="text-align: center; margin-bottom: 1rem; color: #666;">
            Click on any country to see detailed railway statistics. Hover for quick info.
        </p>
        <div id="europe-map"></div>
    </div>

    <div class="selected-country-info" id="selected-country-info">
        <h3 id="selected-country-name">Select a country</h3>
        <div class="country-stats">
            <div class="country-stat">
                <h4>Total Railway Length</h4>
                <div class="value" id="selected-total-length">-</div>
                <small>kilometers</small>
            </div>
            <div class="country-stat">
                <h4>Electrified Length</h4>
                <div class="value" id="selected-electrified-length">-</div>
                <small>kilometers</small>
            </div>
            <div class="country-stat">
                <h4>% Electrified</h4>
                <div class="value" id="selected-electrified-percent">-</div>
                <small>of total network</small>
            </div>
            <div class="country-stat">
                <h4>Annual Passengers</h4>
                <div class="value" id="selected-passengers">-</div>
                <small>million passenger-km</small>
            </div>
        </div>
    </div>

    <div id="operators-by-country" class="tab-content">
        <div class="chart-container">
            <h2 class="chart-title">Number of Train Operators by Country</h2>
            <div id="operators-by-country-chart"></div>
        </div>
        
        <div class="stat-grid">
            <div class="stat-card">
                <h3>Total Countries</h3>
                <div class="value" id="total-countries">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Operators</h3>
                <div class="value" id="total-operators">-</div>
            </div>
            <div class="stat-card">
                <h3>Average Operators per Country</h3>
                <div class="value" id="avg-operators">-</div>
            </div>
            <div class="stat-card">
                <h3>Country with Most Operators</h3>
                <div class="value" id="top-country">-</div>
            </div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Detailed Operators by Country</h2>
            <div id="country-operators-detail"></div>
        </div>
    </div>

    <div id="refund-policies" class="tab-content">
        <div class="chart-container">
            <h2 class="chart-title">Best Refund & Cancellation Policies</h2>
            <div id="policy-rankings"></div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Policy Comparison Metrics</h2>
            <div id="policy-metrics-chart"></div>
        </div>
    </div>

    <div id="superstar-operators" class="tab-content">
        <div class="chart-container">
            <h2 class="chart-title">Top 5 Superstar Operators</h2>
            <p style="text-align: center; margin-bottom: 2rem; color: #666;">
                Based on: Good price, WiFi, electricity plug, catering, high refund %, cancellation possible, modification possible
            </p>
            <div id="superstar-list"></div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Superstar Scoring Methodology</h2>
            <div id="scoring-methodology"></div>
        </div>
    </div>

    <div id="route-comparison" class="tab-content">
        <div class="route-comparison">
            <div class="route-card intercity">
                <h3>Intercity Routes</h3>
                <div class="value" id="intercity-count">-</div>
                <p>Total Routes</p>
                <div style="margin-top: 1rem;">
                    <strong>Avg Price per km: €<span id="intercity-avg-price">-</span></strong><br>
                    <strong>Avg Speed: <span id="intercity-avg-speed">-</span> km/h</strong>
                </div>
            </div>
            
            <div class="route-card international">
                <h3>International Routes</h3>
                <div class="value" id="international-count">-</div>
                <p>Total Routes</p>
                <div style="margin-top: 1rem;">
                    <strong>Avg Price per km: €<span id="international-avg-price">-</span></strong><br>
                    <strong>Avg Speed: <span id="international-avg-speed">-</span> km/h</strong>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Price per km Comparison by Route Type</h2>
            <div id="price-per-km-chart"></div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Best Value Routes (Lowest Price per km)</h2>
            <table class="best-routes-table" id="best-routes-table">
                <thead>
                    <tr>
                        <th>Route</th>
                        <th>Operator</th>
                        <th>Type</th>
                        <th>Distance (km)</th>
                        <th>Price (€)</th>
                        <th>Price per km (€)</th>
                        <th>Speed (km/h)</th>
                    </tr>
                </thead>
                <tbody id="best-routes-body">
                </tbody>
            </table>
        </div>
    </div>

    <div class="loading" id="loading">Loading data...</div>
    <div class="error" id="error" style="display: none;"></div>

    <script>
        let allData = {
            countries: [],
            operators: [],
            routes: [],
            trainOperators: []
        };
        // Load CSV data using Papa Parse
        async function loadData() {
            try {
                const files = [
                    'data/country_passenger_km_train_length.csv',
                    'data/operators.csv',
                    'data/route_breakdown.csv',
                    'data/train_operators_comparison.csv'
                ];

                const responses = await Promise.all(files.map(file => fetch(file)));
                const texts = await Promise.all(responses.map(response => {
                    if (!response.ok) throw new Error(`Failed to load ${response.url}`);
                    return response.text();
                }));

                allData.countries = Papa.parse(texts[0], { header: true, dynamicTyping: true }).data;
                allData.operators = Papa.parse(texts[1], { header: true, dynamicTyping: true }).data;
                allData.routes = Papa.parse(texts[2], { header: true, dynamicTyping: true }).data;
                allData.trainOperators = Papa.parse(texts[3], { header: true, dynamicTyping: true }).data;

                // Clean the data - use correct column names
                allData.countries = allData.countries.filter(d => d.country && d.country.trim());
                allData.operators = allData.operators.filter(d => d.operator && d.operator.trim());
                allData.routes = allData.routes.filter(d => d.operator && d.operator.trim());
                allData.trainOperators = allData.trainOperators.filter(d => d.operator && d.operator.trim());

                console.log('Data loaded:', allData); // Debug log
                
                await initializeVisualization();
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('error').textContent = `Error loading data: ${error.message}`;
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Show/hide tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Initialize map when map tab is shown
            if (tabName === 'europe-map-tab' && !document.querySelector('#europe-map svg')) {
                createEuropeMap();
            }
        }

        async function initializeVisualization() {
            createMapStatistics();
            if (allData.operators.length > 0) {
                createOperatorsByCountryChart();
                createRefundPolicyAnalysis();
                createSuperstarOperators();
                createRouteComparison();
            }
        }

        // Europe Map Functions
        async function createEuropeMap() {
            const mapContainer = document.getElementById('europe-map');
            
            // Clear any existing content
            mapContainer.innerHTML = '';
            
            const svg = d3.select(mapContainer)
                .append('svg')
                .attr('width', '100%')
                .attr('height', 400);

            const width = 800;
            const height = 400;
            svg.attr('viewBox', `0 0 ${width} ${height}`);

            const tooltip = d3.select('body')
                .append('div')
                .attr('class', 'tooltip')
                .style('opacity', 0);

            try {
                // Load European map data
                const europeUrl = 'https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json';
                const world = await d3.json(europeUrl);
                
                // Extract European countries
                const countries = topojson.feature(world, world.objects.countries);
                
                // Define European country bounds for filtering
                const europeanCountries = countries.features.filter(d => {
                    const bounds = d3.geoBounds(d);
                    return bounds[0][0] > -30 && bounds[1][0] < 70 && bounds[0][1] > 30 && bounds[1][1] < 75;
                });

                // Create projection for Europe
                const projection = d3.geoConicConformal()
                    .center([10, 52])
                    .scale(600)
                    .translate([width / 2, height / 2]);

                const path = d3.geoPath().projection(projection);

                // Create countries
                svg.selectAll('.country')
                    .data(europeanCountries)
                    .enter()
                    .append('path')
                    .attr('class', 'country')
                    .attr('d', path)
                    .style('cursor', 'pointer')
                    .on('mouseover', function(event, d) {
                        d3.select(this).style('fill', '#237644');
                        
                        // Find matching country data
                        const countryName = d.properties.NAME || d.properties.NAME_EN;
                        const countryInfo = findCountryData(countryName);
                        
                        if (countryInfo) {
                            tooltip.transition().duration(200).style('opacity', .9);
                            tooltip.html(`
                                <strong>${countryInfo.country}</strong><br/>
                                Passengers: ${(countryInfo.MIO_PKM || 0).toLocaleString()} M<br/>
                                Length: ${(countryInfo.total_length || 0).toLocaleString()} km<br/>
                                % Electrified: ${calculateElectrifiedPercent(countryInfo)}%
                            `)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 28) + 'px');
                        } else {
                            tooltip.transition().duration(200).style('opacity', .9);
                            tooltip.html(`<strong>${countryName}</strong><br/>No data available`)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 28) + 'px');
                        }
                    })
                    .on('mouseout', function() {
                        d3.select(this).style('fill', '#bbebd3');
                        tooltip.transition().duration(500).style('opacity', 0);
                    })
                    .on('click', function(event, d) {
                        const countryName = d.properties.NAME || d.properties.NAME_EN;
                        const countryInfo = findCountryData(countryName);
                        if (countryInfo) {
                            selectCountry(countryInfo);
                        }
                    });

                // Add country labels for countries with data
                svg.selectAll('.country-label')
                    .data(europeanCountries.filter(d => {
                        const countryName = d.properties.NAME || d.properties.NAME_EN;
                        return findCountryData(countryName);
                    }))
                    .enter()
                    .append('text')
                    .attr('class', 'country-label')
                    .attr('transform', d => `translate(${path.centroid(d)})`)
                    .attr('text-anchor', 'middle')
                    .attr('dominant-baseline', 'central')
                    .style('font-size', '8px')
                    .style('fill', '#237644')
                    .style('font-weight', '600')
                    .style('pointer-events', 'none')
                    .text(d => {
                        const countryName = d.properties.NAME || d.properties.NAME_EN;
                        const countryInfo = findCountryData(countryName);
                        return countryInfo ? getCountryCode(countryName) : '';
                    });

            } catch (error) {
                console.error('Error loading map data:', error);
                // Fallback to simple representation
                createFallbackMap();
            }
        }

        function findCountryData(mapCountryName) {
            if (!mapCountryName || !allData.countries || allData.countries.length === 0) {
                return null;
            }
            
            // Direct match (case insensitive)
            let country = allData.countries.find(d => 
                d.country && d.country.toLowerCase().trim() === mapCountryName.toLowerCase().trim()
            );
            
            if (country) {
                return country;
            }
            
            // Simple name mappings for known differences
            const nameMapping = {
                'Czech Republic': 'Czech',
                'Czechia': 'Czech',
                'Macedonia': 'North Macedonia'
            };
            
            // Check if map country name has a known mapping
            const mappedName = nameMapping[mapCountryName];
            if (mappedName) {
                country = allData.countries.find(d => 
                    d.country && d.country.toLowerCase().trim() === mappedName.toLowerCase().trim()
                );
                if (country) {
                    return country;
                }
            }
            
            // Check reverse mapping
            for (const [mapName, dataName] of Object.entries(nameMapping)) {
                if (dataName.toLowerCase() === mapCountryName.toLowerCase()) {
                    country = allData.countries.find(d => 
                        d.country && d.country.toLowerCase().trim() === dataName.toLowerCase().trim()
                    );
                    if (country) {
                        return country;
                    }
                }
            }
            
            return null;
        }

        function calculateElectrifiedPercent(countryInfo) {
            if (!countryInfo || !countryInfo.total_length || countryInfo.total_length === 0) {
                return 0;
            }
            
            // Check if we have a percentage string
            if (countryInfo['% electried length'] && typeof countryInfo['% electried length'] === 'string') {
                return parseInt(countryInfo['% electried length'].replace('%', ''));
            }
            
            // Calculate from lengths
            const electrified = countryInfo.eletrified_rail_length || 0;
            const total = countryInfo.total_length || 0;
            
            if (total === 0) return 0;
            return Math.round((electrified / total) * 100);
        }

        function selectCountry(countryInfo) {
            const infoDiv = document.getElementById('selected-country-info');
            infoDiv.style.display = 'block';
            
            document.getElementById('selected-country-name').textContent = countryInfo.country;
            document.getElementById('selected-total-length').textContent = (countryInfo.total_length || 0).toLocaleString();
            document.getElementById('selected-electrified-length').textContent = (countryInfo.eletrified_rail_length || 0).toLocaleString();
            document.getElementById('selected-electrified-percent').textContent = calculateElectrifiedPercent(countryInfo) + '%';
            document.getElementById('selected-passengers').textContent = (countryInfo.MIO_PKM || 0).toLocaleString();
        }

        function getCountryCode(countryName) {
            const codes = {
                'Germany': 'DE', 'France': 'FR', 'Italy': 'IT', 'Spain': 'ES',
                'United Kingdom': 'UK', 'Poland': 'PL', 'Netherlands': 'NL',
                'Belgium': 'BE', 'Czech Republic': 'CZ', 'Czech': 'CZ', 'Austria': 'AT',
                'Switzerland': 'CH', 'Sweden': 'SE', 'Norway': 'NO',
                'Denmark': 'DK', 'Finland': 'FI', 'Portugal': 'PT',
                'Greece': 'GR', 'Ireland': 'IE', 'Hungary': 'HU',
                'Romania': 'RO', 'Bulgaria': 'BG', 'Croatia': 'HR',
                'Slovenia': 'SI', 'Slovakia': 'SK', 'Estonia': 'EE',
                'Latvia': 'LV', 'Lithuania': 'LT', 'Luxembourg': 'LU',
                'North Macedonia': 'MK', 'Turkey': 'TR'
            };
            return codes[countryName] || countryName.substring(0, 2).toUpperCase();
        }

        function createFallbackMap() {
            const mapContainer = document.getElementById('europe-map');
            mapContainer.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: 400px; background: #f8f9fa; border-radius: 8px;">
                    <div style="text-align: center; color: #666;">
                        <h3>Map loading temporarily unavailable</h3>
                        <p>Please check the country statistics below</p>
                    </div>
                </div>
            `;
        }

        function createMapStatistics() {
            if (!allData.countries || allData.countries.length === 0) {
                return;
            }

            // Calculate totals and averages
            const totalCountries = allData.countries.length;
            const totalLength = allData.countries.reduce((sum, d) => sum + (d.total_length || 0), 0);
            const avgElectrification = allData.countries.reduce((sum, d) => sum + calculateElectrifiedPercent(d), 0) / totalCountries;
            
            // Find most electrified country
            const mostElectrified = allData.countries.reduce((max, d) => {
                const percent = calculateElectrifiedPercent(d);
                return percent > calculateElectrifiedPercent(max) ? d : max;
            }, allData.countries[0]);

            // Update statistics
            document.getElementById('map-total-countries').textContent = totalCountries;
            document.getElementById('map-total-length').textContent = totalLength.toLocaleString();
            document.getElementById('map-avg-electrification').textContent = Math.round(avgElectrification) + '%';
            document.getElementById('map-most-electrified').textContent = mostElectrified.country;
        }


        function createOperatorsByCountryChart() {
            if (!allData.operators || allData.operators.length === 0) return;

            // Count operators by country
            const operatorsByCountry = d3.rollup(
                allData.operators,
                v => v.length,
                d => d.country
            );

            const data = Array.from(operatorsByCountry, ([country, count]) => ({country, count}))
                .sort((a, b) => b.count - a.count);

            // Update stats
            document.getElementById('total-countries').textContent = data.length;
            document.getElementById('total-operators').textContent = allData.operators.length;
            document.getElementById('avg-operators').textContent = (allData.operators.length / data.length).toFixed(1);
            document.getElementById('top-country').textContent = data[0]?.country || '-';

            // Create chart
            const container = d3.select('#operators-by-country-chart');
            container.selectAll('*').remove(); // Clear existing content
            
            const svg = container.append('svg')
                .attr('width', '100%')
                .attr('height', 400);

            const margin = {top: 20, right: 30, bottom: 100, left: 60};
            const width = 800 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            svg.attr('viewBox', `0 0 800 400`);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .rangeRound([0, width])
                .padding(0.1)
                .domain(data.map(d => d.country));

            const y = d3.scaleLinear()
                .rangeRound([height, 0])
                .domain([0, d3.max(data, d => d.count)]);

            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');

            g.append('g')
                .call(d3.axisLeft(y));

            g.selectAll('.bar')
                .data(data)
                .enter().append('rect')
                .attr('class', 'bar')
                .attr('x', d => x(d.country))
                .attr('y', d => y(d.count))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d.count))
                .attr('fill', '#bbebd3')
                .attr('stroke', '#237644')
                .attr('stroke-width', 1);

            // Add value labels on bars
            g.selectAll('.bar-label')
                .data(data)
                .enter().append('text')
                .attr('class', 'bar-label')
                .attr('x', d => x(d.country) + x.bandwidth() / 2)
                .attr('y', d => y(d.count) - 5)
                .attr('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('font-weight', '600')
                .style('fill', '#237644')
                .text(d => d.count);

            // Create detailed operators list
            const detailContainer = d3.select('#country-operators-detail');
            detailContainer.selectAll('*').remove();
            
            data.forEach(({country, count}) => {
                const countryOperators = allData.operators.filter(d => d.country === country);
                const operatorList = countryOperators.map(d => d.operator).join(', ');
                
                detailContainer.append('div')
                    .attr('class', 'policy-card')
                    .html(`
                        <h3>${country} (${count} operators)</h3>
                        <p>${operatorList}</p>
                    `);
            });
        }

        function createRefundPolicyAnalysis() {
            if (!allData.trainOperators || allData.trainOperators.length === 0) return;

            // Analyze refund and cancellation policies
            const policyScores = allData.trainOperators.map(op => {
                let score = 0;
                
                if (op.cancellation_possible === 'yes') score += 2;
                if (op.refund_cancell === 'yes') score += 3;
                else if (op.refund_cancell === 'partial') score += 1;
                if (op.modify_posible === 'yes') score += 2;
                
                return {
                    operator: op.operator,
                    score: score,
                    cancellation: op.cancellation_possible,
                    refund: op.refund_cancell,
                    modify: op.modify_posible
                };
            }).sort((a, b) => b.score - a.score);

            // Display top policy operators
            const policyContainer = d3.select('#policy-rankings');
            policyContainer.selectAll('*').remove();
            
            policyScores.slice(0, 10).forEach((op, i) => {
                const cardClass = i < 3 ? 'policy-card excellent' : 'policy-card';
                policyContainer.append('div')
                    .attr('class', cardClass)
                    .html(`
                        <h3>#${i + 1} ${op.operator}</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
                            <span><strong>Cancellation:</strong> ${op.cancellation}</span>
                            <span><strong>Refund:</strong> ${op.refund}</span>
                            <span><strong>Modify:</strong> ${op.modify}</span>
                        </div>
                        <div style="text-align: right; margin-top: 0.5rem;">
                            <strong>Policy Score: ${op.score}/7</strong>
                        </div>
                    `);
            });

            // Create policy metrics chart
            const policyData = [
                { policy: 'Cancellation Possible', count: allData.trainOperators.filter(d => d.cancellation_possible === 'yes').length },
                { policy: 'Full Refund', count: allData.trainOperators.filter(d => d.refund_cancell === 'yes').length },
                { policy: 'Partial Refund', count: allData.trainOperators.filter(d => d.refund_cancell === 'partial').length },
                { policy: 'Modification Possible', count: allData.trainOperators.filter(d => d.modify_posible === 'yes').length }
            ];

            const metricsContainer = d3.select('#policy-metrics-chart');
            metricsContainer.selectAll('*').remove();
            
            const svg = metricsContainer.append('svg')
                .attr('width', '100%')
                .attr('height', 300);

            const margin = {top: 20, right: 30, bottom: 60, left: 60};
            const width = 600 - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            svg.attr('viewBox', `0 0 600 300`);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .rangeRound([0, width])
                .padding(0.1)
                .domain(policyData.map(d => d.policy));

            const y = d3.scaleLinear()
                .rangeRound([height, 0])
                .domain([0, d3.max(policyData, d => d.count)]);

            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');

            g.append('g')
                .call(d3.axisLeft(y));

            g.selectAll('.bar')
                .data(policyData)
                .enter().append('rect')
                .attr('class', 'bar')
                .attr('x', d => x(d.policy))
                .attr('y', d => y(d.count))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d.count))
                .attr('fill', '#237644')
                .attr('stroke', '#bbebd3')
                .attr('stroke-width', 1);

            g.selectAll('.bar-label')
                .data(policyData)
                .enter().append('text')
                .attr('class', 'bar-label')
                .attr('x', d => x(d.policy) + x.bandwidth() / 2)
                .attr('y', d => y(d.count) - 5)
                .attr('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('font-weight', '600')
                .style('fill', '#237644')
                .text(d => d.count);
        }

        function createSuperstarOperators() {
            if (!allData.trainOperators || allData.trainOperators.length === 0) return;

            // Calculate superstar scores based on multiple criteria
            const superstarScores = allData.trainOperators.map(op => {
                let score = 0;
                let details = [];
                
                // Price factor (higher speed = better value)
                if (op.average_speed > 100) {
                    score += 3;
                    details.push('High Speed');
                } else if (op.average_speed > 80) {
                    score += 2;
                    details.push('Good Speed');
                } else if (op.average_speed > 60) {
                    score += 1;
                    details.push('Decent Speed');
                }
                
                // Services
                if (op.Wifi === 'yes') {
                    score += 1;
                    details.push('WiFi');
                }
                if (op.electricity_plug === 'yes') {
                    score += 1;
                    details.push('Power Outlets');
                }
                if (op.catering_offer === 'yes') {
                    score += 1;
                    details.push('Catering');
                }
                
                // Policy flexibility
                if (op.refund_cancell === 'yes') {
                    score += 2;
                    details.push('Full Refund');
                } else if (op.refund_cancell === 'partial') {
                    score += 1;
                    details.push('Partial Refund');
                }
                
                if (op.cancellation_possible === 'yes') {
                    score += 1;
                    details.push('Cancellation');
                }
                
                if (op.modify_posible === 'yes') {
                    score += 1;
                    details.push('Modification');
                }
                
                return {
                    operator: op.operator,
                    score: score,
                    details: details,
                    speed: op.average_speed,
                    maxScore: 10
                };
            }).sort((a, b) => b.score - a.score);

            // Display top 5 superstar operators
            const superstarContainer = d3.select('#superstar-list');
            superstarContainer.selectAll('*').remove();
            
            superstarScores.slice(0, 5).forEach((op, i) => {
                superstarContainer.append('div')
                    .attr('class', 'superstar-card')
                    .html(`
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3>#${i + 1} ${op.operator}</h3>
                                <p>Average Speed: ${op.speed} km/h</p>
                            </div>
                            <div class="superstar-score">${op.score}/${op.maxScore}</div>
                        </div>
                        <div class="operator-details">
                            ${op.details.map(detail => `<span>${detail}</span>`).join('')}
                        </div>
                    `);
            });

            // Create scoring methodology
            const methodologyContainer = d3.select('#scoring-methodology');
            methodologyContainer.html(`
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div class="stat-card">
                        <h3>Speed Scoring</h3>
                        <p>High Speed (>100 km/h): 3 points<br>
                        Good Speed (80-100 km/h): 2 points<br>
                        Decent Speed (60-80 km/h): 1 point</p>
                    </div>
                    <div class="stat-card">
                        <h3>Service Amenities</h3>
                        <p>WiFi: 1 point<br>
                        Power Outlets: 1 point<br>
                        Catering: 1 point</p>
                    </div>
                    <div class="stat-card">
                        <h3>Policy Flexibility</h3>
                        <p>Full Refund: 2 points<br>
                        Partial Refund: 1 point<br>
                        Cancellation: 1 point<br>
                        Modification: 1 point</p>
                    </div>
                </div>
            `);
        }

        function createRouteComparison() {
            if (!allData.routes || allData.routes.length === 0) return;

            // Separate intercity and international routes
            const intercityRoutes = allData.routes.filter(d => 
                d.intercity_or_international && d.intercity_or_international.toLowerCase().includes('intercity')
            );
            const internationalRoutes = allData.routes.filter(d => 
                d.intercity_or_international && d.intercity_or_international.toLowerCase().includes('international')
            );

            // Calculate averages
            const intercityAvgPrice = d3.mean(intercityRoutes, d => parseFloat(d[' price_eur ']) / d.distance_km) || 0;
            const internationalAvgPrice = d3.mean(internationalRoutes, d => parseFloat(d[' price_eur ']) / d.distance_km) || 0;
            const intercityAvgSpeed = d3.mean(intercityRoutes, d => d.speed_km_per_hour) || 0;
            const internationalAvgSpeed = d3.mean(internationalRoutes, d => d.speed_km_per_hour) || 0;

            // Update route comparison cards
            document.getElementById('intercity-count').textContent = intercityRoutes.length;
            document.getElementById('international-count').textContent = internationalRoutes.length;
            document.getElementById('intercity-avg-price').textContent = intercityAvgPrice.toFixed(3);
            document.getElementById('international-avg-price').textContent = internationalAvgPrice.toFixed(3);
            document.getElementById('intercity-avg-speed').textContent = intercityAvgSpeed.toFixed(1);
            document.getElementById('international-avg-speed').textContent = internationalAvgSpeed.toFixed(1);

            // Create charts and tables (simplified for demo)
            const tableBody = document.getElementById('best-routes-body');
            tableBody.innerHTML = '';
            
            allData.routes.forEach((route, i) => {
                if (i < 5) { // Show first 5 routes
                    const row = tableBody.insertRow();
                    const pricePerKm = parseFloat(route[' price_eur ']) / route.distance_km;
                    row.innerHTML = `
                        <td>${route.route}</td>
                        <td>${route.operator}</td>
                        <td>${route.intercity_or_international}</td>
                        <td>${route.distance_km}</td>
                        <td>€${parseFloat(route[' price_eur ']).toFixed(2)}</td>
                        <td>€${pricePerKm.toFixed(3)}</td>
                        <td>${route.speed_km_per_hour}</td>
                    `;
                }
            });
        }

        // Initialize the application
        loadData();
    </script>
</body>
</html>